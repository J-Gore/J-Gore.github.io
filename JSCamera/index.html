<html>

<head>
    <link rel="stylesheet" type="text/css" href="JSCamera.css">
    <title>Card Upload</title>
</head>

<body>
    <div id="container">
        <image class="left hidden" src="boundary.svg"></image>
        <image class="right mirrored hidden" src="boundary.svg"></image>

        <video class="mirrored user" playsinline autoplay></video>
        <canvas class="hidden"></canvas>

        <div class="controls">
            <button class="snapShot">ðŸ“·</button>

            <a class="save"><button>ðŸ’¾</button></a>

            <button class="switch">ðŸ”„</button>
        </div>

        <p class="deets"></p>
        
        <!-- <a href="https://github.com/webrtc/samples/tree/gh-pages/src/content/getusermedia/canvas"
            title="Stolen from GitHub" id="viewSource">Stolen From GitHub</a> -->

    </div>
</body>

<script>
    const video = document.querySelector('video');
    const canvas = window.canvas = document.querySelector('canvas');
    const videoSelect = document.querySelector('select#videoSource');
    const switchCamera = document.querySelector('.switch');
    const deets = document.querySelector('.deets');

    const snapShot = document.querySelector('.snapShot');

    snapShot.onclick = function () {
        var width = video.videoWidth;
        var height = video.videoHeight;
        
        canvas.width = width;
        canvas.height = height;

        video.classList.add("hidden");       
        canvas.classList.remove("hidden");
               
        var cardHeight = width * 0.63;
        var cropStartY = height * 0.5 - cardHeight * 0.5;
        
        canvas.width = width;
        canvas.height = cardHeight;

        canvas.getContext('2d').drawImage(video, 0, cropStartY, width, cardHeight, 0, cropStartY, width, cardHeight);

        deets.innerText = "Video Height: " + height +
                        " Video Width: " + width +
                        " Card Height: " + cardHeight + 
                        " Crop Start Y: " + cropStartY
    };



    switchCamera.onclick = function () {
        if (video.classList.contains("user")) {
            video.classList.remove("user");
            video.classList.remove("mirrored");
            start(rearCameraConstraints);
        } else {
            video.classList.add("user");
            video.classList.add("mirrored");
            start(frontCameraConstraints);
        }
    };

    var link = document.querySelector('.save');
    link.addEventListener('click', function (ev) {
        link.href = canvas.toDataURL();
        link.download = "mypainting.png";
    }, false);

    const rearCameraConstraints = {
        audio: false,
        video: { facingMode: { exact: "environment" } }
    };

    const frontCameraConstraints = {
        audio: false,
        video: { facingMode: { exact: "user" } }
    };

    function handleSuccess(stream) {
        window.stream = stream; // make stream available to browser console
        video.srcObject = stream;
    }

    function handleError(error) {
        console.log('navigator.MediaDevices.getUserMedia error: ', error.message, error.name);
    }

    start(frontCameraConstraints);

    // function gotDevices(deviceInfos) {
    //     for (let i = 0; i !== deviceInfos.length; ++i) {
    //         const deviceInfo = deviceInfos[i];
    //         const option = document.createElement('option');
    //         option.value = deviceInfo.deviceId;

    //         if (deviceInfo.kind === 'videoinput') {
    //             option.text = deviceInfo.label || `camera ${videoSelect.length + 1}`;
    //             videoSelect.appendChild(option);
    //         } else {
    //             console.log('Some other kind of source/device: ', deviceInfo);
    //         }
    //     }
    //     if (videoSelect.children.length > 1) {
    //         videoSelect.parentElement.classList.remove("hidden");
    //     }
    // }

    function start(constraints) {
        navigator.mediaDevices.getUserMedia(constraints).then(handleSuccess).catch(handleError);

    }

   // videoSelect.onchange = start;
</script>

</html>