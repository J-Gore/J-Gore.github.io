<html>

<head>
    <link rel="stylesheet" type="text/css" href="JSCamera.css">
    <title>Card Upload</title>
</head>

<body>
    <div id="container">
        

        <image class="left hidden" src="boundary.svg"></image>
        <image class="right mirrored hidden" src="boundary.svg"></image>

        <video class="mirrored user" playsinline autoplay></video>
        <canvas class="hidden"></canvas>

        <div class="controls">
            <button class="snapShot">ðŸ“·</button>

            <a class="save"><button>ðŸ’¾</button></a>

            <button class="switch">ðŸ”„</button>
        </div>

        <svg class="boundingSvg" width="20" height="20">
            <line class="topLine" x1="0" y1="0" x2="0" y2="0" />
            <line class="bottomLine" x1="0" y1="0" x2="0" y2="0" />
            <line class="leftLine" x1="0" y1="0" x2="0" y2="0" />
            <line class="rightLine" x1="0" y1="0" x2="0" y2="0" />
        </svg>
        
        <p class="deets"></p>
    </div>
</body>

<script>
    const video = document.querySelector('video');
    const canvas = window.canvas = document.querySelector('canvas');
    const videoSelect = document.querySelector('select#videoSource');
    const switchCamera = document.querySelector('.switch');
    const deets = document.querySelector('.deets');
    const container = document.querySelector('#container');

    const snapShot = document.querySelector('.snapShot');
    var svg = document.querySelector('.boundingSvg');

    var aspectRatio = 0.63;

    var width;
    var height;
    var cardHeight;
    var cropStartY;

    snapShot.onclick = function () {    
        svg.classList.add("hidden");
        calculateBoundingBox();
        console.log("Taking a picture");    

        var actualWidth = video.videoWidth;
        var actualHeight = video.videoHeight;
        var actualCardHeight = actualWidth * aspectRatio;
        var actualCropStartY = actualHeight * 0.5 - actualCardHeight * 0.5;

        canvas.width = width;
        canvas.height = cardHeight;

        video.classList.add("hidden");
        canvas.classList.remove("hidden");
                     
        canvas.getContext('2d').drawImage(video, 0, actualCropStartY, actualWidth, actualCardHeight, 0, 0, width, cardHeight);

        deets.innerText = "Video Height: " + height +
                        " Video Width: " + width +
                        " Card Height: " + cardHeight + 
                        " Crop Start Y: " + cropStartY
    };

    video.addEventListener("play", function() {
        calculateBoundingBox();
    });

    function calculateBoundingBox() {
        console.log("calculating bounding box");
        
        var topLine = document.querySelector('.topLine');
        var bottomLine = document.querySelector('.bottomLine');
        var leftLine = document.querySelector('.leftLine');
        var rightLine = document.querySelector('.rightLine');

        //width = video.videoWidth;
        width = parseInt(window.getComputedStyle(video).width);

        //height = video.videoHeight;
        height = parseInt(window.getComputedStyle(video).height);

        svg.setAttribute("width", width);
        svg.setAttribute("height", height);

        cardHeight = width * aspectRatio;
        cropStartY = height * 0.5 - cardHeight * 0.5;

        topLine.setAttribute("x1", 0);
        topLine.setAttribute("y1", cropStartY);
        topLine.setAttribute("x2", width);
        topLine.setAttribute("y2", cropStartY);

        bottomLine.setAttribute("x1", 0);
        bottomLine.setAttribute("y1", cropStartY + cardHeight);
        bottomLine.setAttribute("x2", width);
        bottomLine.setAttribute("y2", cropStartY + cardHeight);

        deets.innerText = "Video Height: " + height +
                        " Video Width: " + width +
                        " Card Height: " + cardHeight + 
                        " Crop Start Y: " + cropStartY
    };

    switchCamera.onclick = function () {
        if (video.classList.contains("user")) {
            video.classList.remove("user");
            video.classList.remove("mirrored");
            start(rearCameraConstraints);
        } else {
            video.classList.add("user");
            video.classList.add("mirrored");
            start(frontCameraConstraints);
        }
    };

    var link = document.querySelector('.save');
    link.addEventListener('click', function (ev) {
        link.href = canvas.toDataURL();
        link.download = "mypainting.png";
    }, false);

    const rearCameraConstraints = {
        audio: false,
        video: { facingMode: { exact: "environment" } }
    };

    const frontCameraConstraints = {
        audio: false,
        video: { facingMode: { exact: "user" } }
    };

    const generalConstraints = {
        audio: false,
        video: true
    }

    function handleSuccess(stream) {
        window.stream = stream; // make stream available to browser console
        video.srcObject = stream;
    }

    function handleError(error) {
        console.log('navigator.MediaDevices.getUserMedia error: ', error.message, error.name);
    }

    start(generalConstraints);

    function start(constraints) {
        navigator.mediaDevices.getUserMedia(constraints).then(handleSuccess).catch(handleError);
    }
</script>

</html>